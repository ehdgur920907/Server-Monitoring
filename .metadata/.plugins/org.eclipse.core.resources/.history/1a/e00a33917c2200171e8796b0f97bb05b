package com.server.netty;

import java.nio.charset.Charset;

import org.apache.ibatis.session.SqlSession;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.json.simple.parser.ParseException;

import com.information.dao.MemoryDAO;
import com.information.get.Memory;


import io.netty.buffer.ByteBuf;
import io.netty.channel.ChannelHandlerContext;
import io.netty.channel.ChannelInboundHandlerAdapter;

public class EchoServerHandler extends ChannelInboundHandlerAdapter {

	private SqlSessionFactory SqlSessionFactory;
	
	public void insert() throws Exception{
		JSONObject json = new JSONObject();
		
		try(SqlSession session = SqlSessionFactory.openSession()){
			Memory memory  = new Memory();
			memory.setFreeMemory(json.get("freeMemory").toString());
			memory.setTotalMemory(json.get("totalMemory").toString());
			memory.setUsedMemory(json.get("usedMemory").toString());		
			session.insert("com.information.get.Memory.insertMemory", memory);

		}
	}
	
	@Override
	public void channelRead(ChannelHandlerContext ctx, Object msg) throws ParseException {
		String readMessage = ((ByteBuf) msg).toString(Charset.defaultCharset());
		
		MemoryDAO  memoryDAO = new MemoryDAO();
		Memory memory = new Memory();
		
		
		JSONParser parser = new JSONParser();
	    JSONObject json = (JSONObject)parser.parse(readMessage);
	    
	    System.out.println(json.get("totalMemory"));
	    System.out.println(json.get("usedMemory"));
	    System.out.println(json.get("freeMemory"));
	}

	@Override
	public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {
		cause.printStackTrace();
		ctx.close();
	}
}